rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Utility: Check if the requester is an authorized admin
    function isAdmin() {
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        request.auth.token.email == 'admin@leadbid.pro' ||
        // Support for the hardcoded admin_1 bypass during genesis
        request.auth.uid == 'admin_1'
      );
    }

    // User Identities: Users can manage their own profile, admins see all.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }
    
    // Lead Assets: Open for browsing, restricted for modification.
    match /leads/{leadId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (resource.data.ownerId == request.auth.uid || isAdmin());
    }
    
    // Bidding Records: Private to participant and admin.
    match /bids/{bidId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null;
    }
    
    // Financial Ledger: Immutable for users, manageable by system/admin.
    match /wallet_activities/{actId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null; // For deposit logs
      allow update, delete: if isAdmin();
    }
    
    // Telemetry & Logs: Users see their own stream.
    match /notifications/{notifId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAdmin() || request.auth != null;
    }
    
    // Infrastructure Config: Admin access only.
    match /api_nodes/{nodeId} {
      allow read, write: if isAdmin();
    }
    
    match /config/{configId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}